<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
              content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>websocket-example</title>
        <style>
            body {
                background-color: #f0f0f0;
                margin-left: auto;
                margin-right: auto;
                width: 60%;
            }
            .login {
                background-color: #fff;
                border: 1px solid #ccc;
                border-radius: 5px;
                padding: 10px;
                width: 50%;
                margin-top: 50px;
            }
            .login form {
                margin: 0;
            }
            .login fieldset {
                border: none;
                margin: 0;
                padding: 0;
            }
            .login legend {
                font-size: 1.2em;
                font-weight: bold;
            }
            .login label {
                display: block;
                margin-top: 10px;
            }
            .login input {
                border: 1px solid #ccc;
                border-radius: 5px;
                padding: 5px;
                width: 50%;
                height: 30px;
            }
            .login button {
                background-color: #007bff;
                border: none;
                border-radius: 5px;
                color: #fff;
                cursor: pointer;
                margin-top: 10px;
                padding: 5px;
                width: 50%;
                height: 30px;
            }
            .nav__div {
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                padding: 10px;
            }

            .status-online {
                background-color: green;
                color: white;
                border-radius: 2px;
                padding: 5px;
            }

            .status-offline {
                background-color: red;
                color: white;
                border-radius: 2px;
                padding: 5px;
            }

            .send__message {
                width: 50%;
                border-right: 1px solid grey;
            }
            
        </style>
    </head>
    <body>
        <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
        <script src="https://unpkg.com/vue-router@4.0.15/dist/vue-router.global.js"></script>
        
        <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

        <div id="app">
            <nav>
                <div class="nav__div" v-if="isLoggedIn">
                    <div style="display: flex; flex-direction: row; column-gap: 10px;">
                        <router-link to="/">Home</router-link>
                        <router-link to="/dashboard">Dashboard</router-link>
                        <router-link to="/other">Other</router-link>
                    </div>

                    <div style="display: flex; flex-direction: row; column-gap: 10px;">
                        <span>Welcome, {{ loggedInUserName }}!</span>
                        <span @click="logout" style="cursor: pointer; color: blue; text-decoration: underline;">Logout</a>
                    </div>
                    
                </div>
                
            </nav>
            <hr/>
            <router-view @login_success="handleLoginSuccess" :messages="messages"></router-view>
            
            <footer style="display: flex; flex-direction: column; margin-top: 100px; text-align: right;">
                <div>
                    <hr />
                </div>
                
                <div v-if="isLoggedIn">
                    Status: <small :class="websocketStatus ? 'status-online' : 'status-offline'">{{ websocketStatus ? 'Connected' : 'Disconnect'}}</small>
                    <small 
                        v-if="!websocketStatus" 
                        @click="establishWebSocketConnection(loggedInUserName)" 
                        style="margin-left: 5px; color: blue; text-decoration: underline; cursor: pointer;">Refresh</small>
                </div>
                <div>
                    <small>WebSocket Example @ all rights reserved!</small>
                </div>
                
            </footer>
        </div>

        <template id="home">
            <div style="display: flex; flex-direction: row; row-gap: 30px;">
                <div class="send__message">
                    <select>
                        <option v-for="o in [1,2,3,4,5]">{{o}}</option>
                    </select>
                    <input type="text" placeholder="Write Messages">
                    <br/>
                    <button>Send</button>
                </div>
                <div class="recived__message">
                    <ul>
                        <li v-for="m in messages">{{m}}</li>
                    </ul>
                </div>
            </div>
        </template>
        
        <template id="login">
            <div class="login">
                <form @submit.prevent="doLogin">
                    <fieldset>
                        <legend>Login</legend>
                        <label for="username">Username:</label>
                        <br/>
                        <input type="text" id="username" v-model="userName" required>
                        
                        <button type="submit">Login</button>
                    </fieldset>   
                </form>
            </div>

        </template>
        
        <script>
            const { ref, createApp, watch, onMounted , toRef} = Vue
            const { createRouter, createMemoryHistory, useRouter } = VueRouter
            const apiHost = 'http://localhost:8080'

            const HOME = {
                template: '#home',
                props: [],
                emit: [],
                setup(props) {
                    const message = ref('Home page')
                    const messages = toRef(props, 'messages')
                    return {
                        message, messages
                    }
                }
            }
            
            const LOGIN = {
                template: '#login',
                setup(props, { emit }) {
                    const message = ref('Login page')
                    const userName = ref('')
                    
                    const doLogin = () => {
                        localStorage.setItem('userId', userName.value)
                        emit('login_success', userName.value)
                        router.push('/')
                    }

                    return {
                        message, userName, doLogin
                    }
                }
            }
            
            const router = createRouter({
                history: createMemoryHistory(),
                routes: [
                    { path: '/', component: HOME },
                    { path: '/login', component: LOGIN },
                    { path: '/dashboard', component: { template: '<h3>Dashboard</h3>' } },
                    { path: '/other', component: { template: '<h3>Other</h3>' } }
                ],
            })

            createApp({
                setup() {
                    const isLoggedIn = ref(false)
                    const loggedInUserName = ref('')
                    const websocketStatus = ref(false)
                    const messages = ref([])

                    const logout = () => {
                        localStorage.removeItem('userId')
                        isLoggedIn.value = false
                        router.push('/login')
                    }

                    const handleLoginSuccess = (data) => {
                        isLoggedIn.value = true
                        loggedInUserName.value = data
                    }

                    const establishWebSocketConnection = (userId) => {
                        const socket = new SockJS(`${apiHost}/stomp-endpoint`);
                        const stompClient = Stomp.over(socket);
                        
                        const availableuser = [1,2,3,4,5]

                        stompClient.connect({}, (frame) => {
                            console.log('Connected: ' + frame);
                            websocketStatus.value = true

                            stompClient.send('/topic/greetings', {}, JSON.stringify({
                                            message: `Hello world from ${userId}`,
                                            userId: userId
                                        }))
                                        
                            setInterval(() => {
                                console.log('setInterval');
                                availableuser.forEach(au => {
                                    if(au != userId) {
                                        stompClient.send('/app/messages', {}, JSON.stringify({
                                            message: `Hello world from ${userId}`,
                                            userId: au
                                        }));
                                    }
                                })
                            }, 10000);

                            
                            
                            stompClient.subscribe(`/user/${userId}/queue/messages`, (message) => {
                                messages.value.push(message)
                                console.log('Received: ' + message);
                            });
                            
                            stompClient.subscribe('/topic/greetings', (greeting) => {
                                messages.value.push(greeting)
                                console.log('greeting', greeting)
                            });
                        });
                    }
                    
                    onMounted(() => {
                        console.log('mounted')
                        const userId = localStorage.getItem('userId')
                        
                        if (userId) {
                            isLoggedIn.value = true
                            loggedInUserName.value = userId
                            establishWebSocketConnection(userId)
                        } else {
                            router.push('/login')
                        }
                    })
                    
                    return {
                        messages, isLoggedIn, logout, 
                            handleLoginSuccess, loggedInUserName, websocketStatus, 
                                establishWebSocketConnection
                    }
                },
                components: {
                    HOME,
                    LOGIN
                }
            }).use(router).mount('#app')
        </script>
    </body>
</html>